name: Deploy JobLynk App to Production

on:
  push:
    branches: [main]
    paths:
      - 'apps/customer-frontend/**'
      - 'voice-call-agent/**'
      - '.github/workflows/app-deploy-prod.yml'
  workflow_dispatch:

concurrency:
  group: joblynk-prod-deploy
  cancel-in-progress: false

jobs:
  validate:
    name: Validate build artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies (including dev)
        working-directory: apps/customer-frontend
        env:
          NODE_ENV: development
          NPM_CONFIG_PRODUCTION: 'false'
        run: npm ci --include=dev || npm install --include=dev

      - name: Build frontend
        working-directory: apps/customer-frontend
        env:
          NODE_OPTIONS: --max-old-space-size=4096
        run: npm run build

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Validate voice-call-agent app import
        working-directory: voice-call-agent
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          python - <<'PY'
          import importlib
          importlib.import_module('app.main')
          print('voice-call-agent import check passed')
          PY

  deploy:
    name: Deploy to production host
    needs: validate
    runs-on: ubuntu-latest
    environment: production
    env:
      PROD_SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
      PROD_SSH_USER: ${{ secrets.PROD_SSH_USER }}
      PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
      PROD_SSH_PORT: ${{ secrets.PROD_SSH_PORT || '22' }}
    steps:
      - name: Validate deploy secrets
        shell: bash
        run: |
          set -euo pipefail
          missing=()
          [ -n "${PROD_SSH_HOST}" ] || missing+=("PROD_SSH_HOST")
          [ -n "${PROD_SSH_USER}" ] || missing+=("PROD_SSH_USER")
          [ -n "${PROD_SSH_KEY}" ] || missing+=("PROD_SSH_KEY")

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing required production environment secrets: ${missing[*]}" >&2
            exit 1
          fi

          # PROD_SSH_PORT defaults to 22 via env expression above.

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ env.PROD_SSH_HOST }}
          username: ${{ env.PROD_SSH_USER }}
          key: ${{ env.PROD_SSH_KEY }}
          port: ${{ env.PROD_SSH_PORT }}
          script_stop: true
          script: |
            # Force-load user environment in non-interactive SSH sessions
            if [ -f "$HOME/.bash_profile" ]; then . "$HOME/.bash_profile"; fi
            if [ -f "$HOME/.bashrc" ]; then . "$HOME/.bashrc"; fi
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" || true

            set -eu

            DEPLOY_PATH="${{ secrets.PROD_DEPLOY_PATH }}"
            if [ -z "${DEPLOY_PATH}" ]; then
              DEPLOY_PATH="/apps/data/joblynktalent"
            fi

            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "DEPLOY_PATH does not exist: $DEPLOY_PATH"
              exit 1
            fi

            if ! command -v sudo >/dev/null 2>&1; then
              echo "sudo is required for deployment on this host"
              exit 1
            fi

            # Runtime diagnostics removed after stabilization.

            # Resolve NPM and handle sudo requirements for root-installed binaries.
            NPM_BIN="$(command -v npm || true)"
            NPM_USE_SUDO=""
            if [ -z "$NPM_BIN" ] || ! [ -x "$NPM_BIN" 2>/dev/null ]; then
              NPM_BIN="$(sudo -n bash -lc 'command -v npm || ls -1 /root/.nvm/versions/node/*/bin/npm 2>/dev/null | tail -n 1' 2>/dev/null || true)"
              if [ -n "$NPM_BIN" ]; then
                NPM_USE_SUDO="sudo -n"
              fi
            fi

            # Resolve PM2 and handle sudo requirements for root-installed binaries.
            PM2_BIN="$(command -v pm2 || true)"
            PM2_USE_SUDO=""
            if [ -z "$PM2_BIN" ] || ! [ -x "$PM2_BIN" 2>/dev/null ]; then
              PM2_BIN="$(sudo -n bash -lc 'command -v pm2 || ls -1 /root/.nvm/versions/node/*/bin/pm2 2>/dev/null | tail -n 1' 2>/dev/null || true)"
              if [ -n "$PM2_BIN" ]; then
                PM2_USE_SUDO="sudo -n"
              fi
            fi

            if [ -z "$PM2_BIN" ]; then
              NVM_PM2="$(find "$HOME/.nvm/versions/node" -maxdepth 4 \( -type f -o -type l \) -name pm2 2>/dev/null | head -n 1 || true)"
              if [ -n "$NVM_PM2" ]; then
                PM2_BIN="$NVM_PM2"
                PM2_USE_SUDO=""
              fi
            fi

            # Binary resolution completed.
            if [ -n "$PM2_USE_SUDO" ]; then
              $PM2_USE_SUDO test -x "$PM2_BIN" || { echo "pm2 not found or not executable via sudo"; exit 127; }
            else
              [ -x "$PM2_BIN" ] || { echo "pm2 not found or not executable for deploy user"; exit 127; }
            fi

            cd "$DEPLOY_PATH"
            git config --global --add safe.directory "$DEPLOY_PATH" || true
            git fetch origin main
            git checkout main
            git reset --hard origin/main

            # Frontend (dependency/build are optional if npm missing on host)
            cd "$DEPLOY_PATH/apps/customer-frontend"
            CAN_RUN_NPM=false
            if [ -n "$NPM_BIN" ]; then
              if [ -n "$NPM_USE_SUDO" ]; then
                $NPM_USE_SUDO test -x "$NPM_BIN" && CAN_RUN_NPM=true || true
              else
                [ -x "$NPM_BIN" ] && CAN_RUN_NPM=true || true
              fi
            fi

            if [ "$CAN_RUN_NPM" = true ]; then
              $NPM_USE_SUDO env NODE_ENV=development NPM_CONFIG_PRODUCTION=false "$NPM_BIN" ci --include=dev || $NPM_USE_SUDO env NODE_ENV=development NPM_CONFIG_PRODUCTION=false "$NPM_BIN" install --include=dev
              $NPM_USE_SUDO env NODE_OPTIONS=--max-old-space-size=4096 "$NPM_BIN" run build || true
            else
              echo "npm not available/executable on host; skipping npm install/build"
            fi
            $PM2_USE_SUDO "$PM2_BIN" restart customer-frontend --update-env

            # Talent backend
            cd "$DEPLOY_PATH/voice-call-agent"
            if [ -d venv ] && [ -x venv/bin/python ]; then
              if [ -f requirements.txt ]; then venv/bin/python -m pip install -r requirements.txt; fi
            else
              echo "venv/bin/python not available; skipping python dependency install"
            fi
            $PM2_USE_SUDO "$PM2_BIN" restart screening-talent --update-env

            # Basic health checks (allow warm-up after PM2 restarts)
            ok_root=0
            ok_talent=0
            for i in $(seq 1 20); do
              if curl -fsS https://screening.joblynk.ai/ >/dev/null; then ok_root=1; fi
              if curl -fsS https://screening.joblynk.ai/talent/login >/dev/null; then ok_talent=1; fi
              if [ "$ok_root" -eq 1 ] && [ "$ok_talent" -eq 1 ]; then
                break
              fi
              sleep 3
            done
            [ "$ok_root" -eq 1 ] || { echo "Health check failed: /"; exit 1; }
            [ "$ok_talent" -eq 1 ] || { echo "Health check failed: /talent/login"; exit 1; }
            echo "Production deployment completed successfully."
