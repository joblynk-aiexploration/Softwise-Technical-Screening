name: Deploy JobLynk App to Production
# trigger: keep workflow file touched for manual redeploys (ownership fix redeploy)

on:
  push:
    branches: [main]
    paths:
      - 'apps/customer-frontend/**'
      - 'voice-call-agent/**'
      - '.github/workflows/app-deploy-prod.yml'
  workflow_dispatch:

concurrency:
  group: joblynk-prod-deploy
  cancel-in-progress: false

jobs:
  validate:
    name: Validate build artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies (including dev)
        working-directory: apps/customer-frontend
        env:
          NODE_ENV: development
          NPM_CONFIG_PRODUCTION: 'false'
        run: npm ci --include=dev || npm install --include=dev

      - name: Build frontend
        working-directory: apps/customer-frontend
        env:
          NODE_OPTIONS: --max-old-space-size=4096
        run: npm run build

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Validate voice-call-agent app import
        working-directory: voice-call-agent
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          python - <<'PY'
          import importlib
          importlib.import_module('app.main')
          print('voice-call-agent import check passed')
          PY

  deploy:
    name: Deploy to production host
    needs: validate
    runs-on: ubuntu-latest
    environment: production
    env:
      PROD_SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
      PROD_SSH_USER: ${{ secrets.PROD_SSH_USER }}
      PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
      PROD_SSH_PORT: ${{ secrets.PROD_SSH_PORT || '22' }}
    steps:
      - name: Validate deploy secrets
        shell: bash
        run: |
          set -euo pipefail
          missing=()
          [ -n "${PROD_SSH_HOST}" ] || missing+=("PROD_SSH_HOST")
          [ -n "${PROD_SSH_USER}" ] || missing+=("PROD_SSH_USER")
          [ -n "${PROD_SSH_KEY}" ] || missing+=("PROD_SSH_KEY")

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing required production environment secrets: ${missing[*]}" >&2
            exit 1
          fi

          if [ -z "${PROD_SSH_PORT}" ]; then
            echo "PROD_SSH_PORT=22" >> "$GITHUB_ENV"
          fi

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ env.PROD_SSH_HOST }}
          username: ${{ env.PROD_SSH_USER }}
          key: ${{ env.PROD_SSH_KEY }}
          port: ${{ env.PROD_SSH_PORT }}
          script_stop: true
          debug: true
          script: |
            # Force-load user environment in non-interactive SSH sessions
            if [ -f "$HOME/.bash_profile" ]; then . "$HOME/.bash_profile"; fi
            if [ -f "$HOME/.bashrc" ]; then . "$HOME/.bashrc"; fi
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" || true

            set -eu

            DEPLOY_PATH="${{ secrets.PROD_DEPLOY_PATH }}"
            if [ -z "${DEPLOY_PATH}" ]; then
              DEPLOY_PATH="/apps/data/joblynktalent"
            fi

            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "DEPLOY_PATH does not exist: $DEPLOY_PATH"
              exit 1
            fi

            if ! command -v sudo >/dev/null 2>&1; then
              echo "sudo is required for deployment on this host"
              exit 1
            fi

            # Use deploy user's toolchain for git. npm/pip are best-effort on host.
            NPM_BIN="$(command -v npm || true)"
            if [ ! -x "$NPM_BIN" ]; then
              NPM_BIN="$(sudo -n bash -lc 'command -v npm' 2>/dev/null || true)"
            fi

            PM2_BIN="$(command -v pm2 || true)"
            PM2_USE_SUDO=""
            if [ ! -x "$PM2_BIN" ]; then
              PM2_BIN="$(sudo -n bash -lc 'command -v pm2' 2>/dev/null || true)"
              PM2_USE_SUDO="sudo -n"
            fi
            if [ ! -x "$PM2_BIN" ]; then
              NVM_PM2="$(find "$HOME/.nvm/versions/node" -maxdepth 4 \( -type f -o -type l \) -name pm2 2>/dev/null | head -n 1 || true)"
              if [ -n "$NVM_PM2" ]; then
                PM2_BIN="$NVM_PM2"
              fi
            fi
            [ -x "$PM2_BIN" ] || { echo "pm2 not found for deploy user or sudo shell"; exit 127; }

            cd "$DEPLOY_PATH"
            git config --global --add safe.directory "$DEPLOY_PATH" || true
            git fetch origin main
            git checkout main
            git reset --hard origin/main

            # Frontend (dependency/build are optional if npm missing on host)
            cd "$DEPLOY_PATH/apps/customer-frontend"
            if [ -x "$NPM_BIN" ]; then
              env NODE_ENV=development NPM_CONFIG_PRODUCTION=false "$NPM_BIN" ci --include=dev || env NODE_ENV=development NPM_CONFIG_PRODUCTION=false "$NPM_BIN" install --include=dev
              env NODE_OPTIONS=--max-old-space-size=4096 "$NPM_BIN" run build || true
            else
              echo "npm not available on host; skipping npm install/build"
            fi
            $PM2_USE_SUDO "$PM2_BIN" restart customer-frontend --update-env

            # Talent backend
            cd "$DEPLOY_PATH/voice-call-agent"
            if [ -d venv ]; then . venv/bin/activate; fi
            if command -v pip >/dev/null 2>&1 && [ -f requirements.txt ]; then pip install -r requirements.txt; else echo "pip not available or requirements missing; skipping pip install"; fi
            $PM2_USE_SUDO "$PM2_BIN" restart screening-talent --update-env

            # Basic health checks
            curl -fsS https://screening.joblynk.ai/ >/dev/null
            curl -fsS https://screening.joblynk.ai/talent/login >/dev/null
            echo "Production deployment completed successfully."
