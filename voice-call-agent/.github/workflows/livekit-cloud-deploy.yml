name: Deploy LiveKit Agent to Cloud

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'livekit_agent/**'
      - '.github/workflows/livekit-cloud-deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      LIVEKIT_URL: ${{ secrets.LIVEKIT_URL }}
      LIVEKIT_API_KEY: ${{ secrets.LIVEKIT_API_KEY }}
      LIVEKIT_API_SECRET: ${{ secrets.LIVEKIT_API_SECRET }}
      LIVEKIT_AGENT_NAME: ${{ secrets.LIVEKIT_AGENT_NAME }}
      LIVEKIT_AGENT_ID: ${{ secrets.LIVEKIT_AGENT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          : "${LIVEKIT_URL:?Missing LIVEKIT_URL secret}"
          : "${LIVEKIT_API_KEY:?Missing LIVEKIT_API_KEY secret}"
          : "${LIVEKIT_API_SECRET:?Missing LIVEKIT_API_SECRET secret}"

      - name: Install LiveKit CLI (lk)
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://get.livekit.io/cli | bash
          echo "$HOME/.livekit/bin" >> "$GITHUB_PATH"
          lk --help >/dev/null

      - name: Deploy LiveKit Cloud agent
        shell: bash
        run: |
          set -euo pipefail
          chmod +x livekit_agent/deploy/deploy_livekit_cloud.sh
          bash livekit_agent/deploy/deploy_livekit_cloud.sh
